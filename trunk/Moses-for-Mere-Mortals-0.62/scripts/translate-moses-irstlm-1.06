#!/usr/bin/env bash
# translate-moses-irstlm
# version 1.07
# author: JoÃ£o L. A. C. Rosas
# date: 24/11/2009
#---------------------------------------------------------------------------------------------------------------------------------------
#THIS SCRIPT ASSUMES THAT A IRSTLM-ENABLED MOSES HAS ALREADY BEEN INSTALLED with create-moses-irstlm IN $mosesdir; ITS VALUE BY DEFAULT IS /home/user/moses-irstlm; CHANGE THIS VARIABLE IF, IN YOUR CASE, IT SHOULD REFER TO A DIFFERENT LOCATION
#IT ALSO ASSUMES THE TRAINING OF A CORPUS HAS ALREADY BEEN DONE WITH train-moses-irstlm
#IT FINALLY ASSUMES THAT YOU HAVE PLACED THE DOCUMENTS TO BE TRANSLATED IN THE $mosesdir/translation_input DIRECTORY (but please see the demomode setting below, so that you can see this script at work without placing documents there)
#NOTE: !!! the present script doesn't test whether a translation already done exists with the same name of a translation you now ask; it therefore will be erase such a translation !!!
#---------------------------------------------------------------------------------------------------------------------------------------
# The values of the variables that follow should be filled according to your needs:
#---------------------------------------------------------------------------------------------------------------------------------------

#Base path of Moses installation
mosesdir=$HOME/moses-irstlm
#Name of the trained corpus directory you want to use for translation (ommit the path!!!); !!! LEAVE EMPTY IF YOU WANT TO USE THE CORPUS CURRENTLY PRESENT IN THE $mosesdir/work DIRECTORY !!!; if you want to specify a different corpus, the easiest thing to do is to copy and paste the name of a corpus present in $mosesdir/corpora_trained)
corpus_name=40000-pt-en-LM100000-Gram5-MM1-T1-MinLen1-MaxLen80-MaxPhraseLength5
#Demo mode: 1 = Yes ; Any other value = No (This setting simply copies the file 100.pt from $mosesdir/corpora_for_training to $mosesdir/translation_input so that you can run this script without changing its settings)
demomode=1
#The next 2 parameters will only be used by this script in case $corpus_name isn't assigned any value; it must specify the languages being used in the corpus currently present in $workdir; it is up to you to check that they are correctly specified !!! THE LANGUAGE ABBREVIATION SHOULD CONTAIN EXACTLY 2 CHARACTERS !!!
lng1=pt
lng2=en
#Create a translation report when translations are finished; 1 = Do; Any other value = Don't
create_translation_report=1
#---------------------------------------------------------------------------------------------------------------------------------------
#end of parameters that you should fill
#---------------------------------------------------------------------------------------------------------------------------------------

#---------------------------------------------------------------------------------------------------------------------------------------
# DON'T CHANGE THE LINES THAT FOLLOW ... unless you know what you are doing!
#---------------------------------------------------------------------------------------------------------------------------------------
startdate=`date +day:%d/%m/%y-time:%H:%M:%S`
echo "********************************** DO PREPARATORY WORK:"
control_c() {
	if [ -f $workdir/model/moses.ini.bak.tuning ]; then
		cp $workdir/model/moses.ini.bak.tuning $workdir/model/moses.ini
	elif [ -f $workdir/model/moses.ini.bak.memmap ]; then
		cp $workdir/model/moses.ini.bak.memmap $workdir/model/moses.ini
	elif [ -f $workdir/model/moses.ini.bak.train ]; then
		cp $workdir/model/moses.ini.bak.train $workdir/model/moses.ini
	fi
	exit
}

trap control_c SIGINT

transfer_from_bak_to_work() {
	#If a previous $mosesdir/work was saved do $mosesdir/bak before the translation started, erase the present $mosesdir/work and move the previous $mosesdir/work to its original location; then erase the now superfluous $mosesdir/bak and $mosesdir/tmp directories
	if [ -d $mosesdir/bak ]; then
		rm -rf $mosesdir/work
		mv $mosesdir/bak/work/ $mosesdir/work
		rm -rf $mosesdir/bak
	fi
	if [ -d $mosesdir/tmp ]; then
		rm -rf $mosesdir/tmp
	fi
}

workdir=$mosesdir/work

lngmdl=1
toolsdir=$mosesdir/tools
docs_to_translate_dir=$mosesdir/translation_input
translated_docs_dir=$mosesdir/translation_output

if [ ! -d $docs_to_translate_dir ]; then
	mkdir $docs_to_translate_dir
	echo "You need to put the file(s) you want to translate in the $docs_to_translate_dir directory."
	exit 0
fi

if [ ! -d $translated_docs_dir ]; then
	mkdir $translated_docs_dir
fi

if [ "$demomode" = "1" ]; then
	if [ -f $mosesdir/corpora_for_training/100.pt ]; then
		cp $mosesdir/corpora_for_training/100.pt $mosesdir/translation_input
	else
		echo "The $mosesdir/corpora_for_training/100.pt file, used in the demo of the present script, doesn't exist anymore. Please set the demomode variable to 0. Exiting ..."
		exit 0
	fi
fi

#If corpus_name specified and different from $workdir, save the present $mosesdir/work directory, if it exists (so that you don't loose any valuable previous work)
if [[ ${corpus_name-_} ]]; then
	if [ "$corpus_name" != "work" ]; then
		if [ -d $workdir ]; then
			if [ -d $mosesdir/bak ]; then
				rm -rf $mosesdir/bak
				mkdir $mosesdir/bak
			else
				mkdir $mosesdir/bak
			fi
			mv $workdir $mosesdir/bak
		fi
	
		#Copy relevant trained corpus to its original location in $mosesdir/work
		for dir in $mosesdir/corpora_trained/$corpus_name*; do
			cp -rf $dir $mosesdir/work/ 2> /dev/null
			#Extract first language name
			lang1temp=${corpus_name#*-}
			lang1=${lang1temp:0:2}
			#Extract second language name
			lang2=${lang1temp:3:2}
			break
		done
		if [ $dir ]; then
			:
		else
			echo "The $mosesdir/corpora_trained/$corpus_name corpus does not exist. Please review the \$corpus_name setting of this script. It should have the name of one of the subdirectories of \$mosesdir/corpora_trained. Exiting ..."
			exit 0
		fi
	fi
else
	if [ ! -d $workdir ]; then
		echo "If you do not specify a corpus name, this script uses the trained corpus in $workdir. There is no such corpus in that location."
		exit 0
	fi
	lang1=$lng1
	lang2=$lng2
fi

#Check training was done correctly in the specified corpus
if [ ! -f $workdir/model/moses.ini ]; then
	echo "The trained corpus you are trying to use wasn't correctly trained or does not exist. Please retrain it or use another trained corpus. Exiting ..."
	transfer_from_bak_to_work
	exit 0
fi

export SCRIPTS_ROOTDIR=$toolsdir/moses/scripts*
#base directory of IRSTLM
export IRSTLM=$toolsdir/irstlm

#Prepare and translate all the files in $docs_to_translate_dir; present the results in $translated_docs_dir
if [ ! -d $mosesdir/tmp ]; then
	mkdir $mosesdir/tmp
fi
tmp=$mosesdir/tmp

echo "********************************** TRANSLATE:"
for filetotranslate in $docs_to_translate_dir/*.*; do
	if [ -f $filetotranslate ]; then
		name=${filetotranslate##*/}
		$toolsdir/scripts/tokenizer.perl -l $lang1 < $filetotranslate > $tmp/$name.tok
		$toolsdir/scripts/lowercase.perl < $tmp/$name.tok > $tmp/$name.lowercase
		#Translate!
		$toolsdir/moses/moses-cmd/src/moses -f $workdir/model/moses.ini < $tmp/$name.lowercase > $tmp/$name
		#Recase the output:
		$toolsdir/moses/scripts*/recaser/recase.perl -model $workdir/recaser/moses.ini -in $tmp/$name -moses $toolsdir/moses/moses-cmd/src/moses > $tmp/$name.recased
		#Detokenize the output:
		$toolsdir/scripts/detokenizer.perl -l $lang2 < $tmp/$name.recased > $translated_docs_dir/$name
	else
		echo "The \$translation_input directory has no documents to be translated. You should place there the documents you want to translate."
		transfer_from_bak_to_work
		exit 0
	fi
done

#Remove the now superfluous $mosesdir/temp directory
rm -rf $mosesdir/tmp


if [ $create_translation_report -eq 1 ]; then
	echo "********************************** BUILD TRANSLATION REPORT:"
	echo "*** Script version ***: translate-moses-irstlm-1.06" > $mosesdir/translation_output/translation_summary
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	echo "*** Duration ***: " >> $mosesdir/translation_output/translation_summary
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	echo "Start time:           $startdate" >> $mosesdir/translation_output/translation_summary
	echo "End time:             `date +day:%d/%m/%y-time:%H:%M:%S`" >> $mosesdir/translation_output/translation_summary
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	echo "*** Moses base directory ***: $mosesdir" >> $mosesdir/translation_output/translation_summary
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	echo "*** Languages*** :" >> $mosesdir/translation_output/translation_summary
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	echo "Source language: $lang1" >> $mosesdir/translation_output/translation_summary
	echo "Destination language: $lang2" >> $mosesdir/translation_output/translation_summary
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	echo "*** Trained corpus used ***:" >> $mosesdir/translation_output/translation_summary
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	if [[ ${corpus_name-_} ]]; then	
		echo "$corpus_name" >> $mosesdir/translation_output/translation_summary
	else
		echo "Trained corpus present in $workdir" >> $mosesdir/translation_output/translation_summary
	fi
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	echo "*** Translated Files ***:" >> $mosesdir/translation_output/translation_summary
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	for filetotranslate in $docs_to_translate_dir/*.*; do
		if [[ ${filetotranslate-_} ]]; then
			echo ${filetotranslate##*/} >> $mosesdir/translation_output/translation_summary
		fi
	done
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	echo "*** General Settings *** :" >> $mosesdir/translation_output/translation_summary
	echo "------------------------------------------------------------------------" >> $mosesdir/translation_output/translation_summary
	echo "lngmdl=$lngmdl (0 = SRILM; 1 = IRSTLM; 5 = RandLM)" >> $mosesdir/translation_output/translation_summary
fi

